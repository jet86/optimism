"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.invoke = exports.fallback = exports.Invokation = exports.Failure = exports.InvokationRevertFailure = exports.InvokationError = void 0;
const ErrorReporter_1 = require("./ErrorReporter");
const Utils_1 = require("./Utils");
const errorRegex = /^(.*) \((\d+)\)$/;
function getErrorCode(revertMessage) {
    let res = errorRegex.exec(revertMessage);
    if (res) {
        return [res[1], Number(res[2])];
    }
    else {
        return null;
    }
}
class InvokationError extends Error {
    // function : string
    // arguments : {[]}
    constructor(err) {
        super(err.message);
        this.err = err;
    }
    toString() {
        return `InvokationError<err=${this.err.toString()}>`;
    }
}
exports.InvokationError = InvokationError;
class InvokationRevertFailure extends InvokationError {
    constructor(err, errMessage, errCode, error) {
        super(err);
        this.errMessage = errMessage;
        this.errCode = errCode;
        this.error = error;
    }
    toString() {
        return `InvokationRevertError<errMessage=${this.errMessage},errCode=${this.errCode},error=${this.error}>`;
    }
}
exports.InvokationRevertFailure = InvokationRevertFailure;
class Failure {
    constructor(error, info, detail) {
        this.error = error;
        this.info = info;
        this.detail = detail;
    }
    toString() {
        return `Failure<error=${this.error},info=${this.info},detail=${this.detail}>`;
    }
    equals(other) {
        return (this.error === other.error &&
            this.info === other.info &&
            this.detail === other.detail);
    }
}
exports.Failure = Failure;
class Invokation {
    constructor(value, receipt, error, fn, errorReporter = ErrorReporter_1.NoErrorReporter) {
        this.value = value;
        this.receipt = receipt;
        this.error = error;
        this.errorReporter = errorReporter;
        if (fn !== null) {
            this.method = fn._method.name;
            this.args = fn.arguments.map((argument, i) => ({ arg: fn._method.inputs[i].name, val: argument }));
        }
        else {
            this.method = null;
            this.args = [];
        }
        if (receipt !== null && receipt.events && receipt.events["Failure"]) {
            const failures = Utils_1.mustArray(receipt.events["Failure"]);
            this.failures = failures.map((failure) => {
                const { 'error': errorVal, 'info': infoVal, 'detail': detailVal } = failure.returnValues;
                return new Failure(errorReporter.getError(errorVal) || `unknown error=${errorVal}`, errorReporter.getInfo(infoVal) || `unknown info=${infoVal}`, errorReporter.getDetail(errorVal, detailVal));
            });
        }
        else {
            this.failures = [];
        }
    }
    success() {
        return (this.error === null && this.failures.length === 0);
    }
    invokation() {
        if (this.method) {
            let argStr = this.args.map(({ arg, val }) => `${arg}=${val.toString()}`).join(',');
            return `"${this.method}(${argStr})"`;
        }
        else {
            return `unknown method`;
        }
    }
    toString() {
        return `Invokation<${this.invokation()}, tx=${this.receipt ? this.receipt.transactionHash : ''}, value=${this.value ? this.value.toString() : ''}, error=${this.error}, failures=${this.failures.toString()}>`;
    }
}
exports.Invokation = Invokation;
async function fallback(world, from, to, value) {
    let trxObj = {
        from: from,
        to: to,
        value: value.toString()
    };
    let estimateGas = async (opts) => {
        let trxObjMerged = {
            ...trxObj,
            ...opts
        };
        return await world.web3.eth.estimateGas(trxObjMerged);
    };
    let call = async (opts) => {
        let trxObjMerged = {
            ...trxObj,
            ...opts
        };
        return await world.web3.eth.call(trxObjMerged);
    };
    let send = async (opts) => {
        let trxObjMerged = {
            ...trxObj,
            ...opts
        };
        let receipt = await world.web3.eth.sendTransaction(trxObjMerged);
        receipt.events = {};
        return receipt;
    };
    let fn = {
        estimateGas: estimateGas,
        call: call,
        send: send,
        _method: {
            name: "fallback",
            inputs: []
        },
        arguments: []
    };
    return invoke(world, fn, from, ErrorReporter_1.NoErrorReporter);
}
exports.fallback = fallback;
async function invoke(world, fn, from, errorReporter = ErrorReporter_1.NoErrorReporter) {
    let value = null;
    let result = null;
    let worldInvokationOpts = world.getInvokationOpts({ from: from });
    let trxInvokationOpts = world.trxInvokationOpts.toJS();
    let invokationOpts = {
        ...worldInvokationOpts,
        ...trxInvokationOpts
    };
    if (world.totalGas) {
        invokationOpts = {
            ...invokationOpts,
            gas: world.totalGas
        };
    }
    else {
        try {
            const gas = await fn.estimateGas({ ...invokationOpts });
            invokationOpts = {
                ...invokationOpts,
                gas: gas * 2
            };
        }
        catch (e) {
            invokationOpts = {
                ...invokationOpts,
                gas: 2000000
            };
        }
    }
    try {
        let error = null;
        try {
            value = await fn.call({ ...invokationOpts });
        }
        catch (err) {
            error = new InvokationError(err);
        }
        if (world.dryRun) {
            world.printer.printLine(`Dry run: invoking \`${fn._method.name}\``);
            // XXXS
            result = {
                blockNumber: -1,
                transactionHash: '0x',
                gasUsed: 0,
                events: {}
            };
        }
        else {
            result = await fn.send({ ...invokationOpts });
            world.gasCounter.value += result.gasUsed;
        }
        if (world.settings.printTxLogs) {
            const eventLogs = Object.values(result && result.events || {}).map((event) => {
                const eventLog = event.raw;
                if (eventLog) {
                    const eventDecoder = world.eventDecoder[eventLog.topics[0]];
                    if (eventDecoder) {
                        return eventDecoder(eventLog);
                    }
                    else {
                        return eventLog;
                    }
                }
            });
            console.log('EMITTED EVENTS:   ', eventLogs);
        }
        return new Invokation(value, result, null, fn, errorReporter);
    }
    catch (err) {
        if (errorReporter) {
            let decoded = getErrorCode(err.message);
            if (decoded) {
                let [errMessage, errCode] = decoded;
                return new Invokation(value, result, new InvokationRevertFailure(err, errMessage, errCode, errorReporter.getError(errCode)), fn, errorReporter);
            }
        }
        return new Invokation(value, result, new InvokationError(err), fn, errorReporter);
    }
}
exports.invoke = invoke;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW52b2thdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9JbnZva2F0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1EQUEyRjtBQUMzRixtQ0FBb0M7QUFLcEMsTUFBTSxVQUFVLEdBQUcsa0JBQWtCLENBQUE7QUFFckMsU0FBUyxZQUFZLENBQUMsYUFBcUI7SUFDekMsSUFBSSxHQUFHLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUV6QyxJQUFJLEdBQUcsRUFBRTtRQUNQLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDakM7U0FBTTtRQUNMLE9BQU8sSUFBSSxDQUFDO0tBQ2I7QUFDSCxDQUFDO0FBUUQsTUFBYSxlQUFnQixTQUFRLEtBQUs7SUFFeEMsb0JBQW9CO0lBQ3BCLG1CQUFtQjtJQUVuQixZQUFZLEdBQVU7UUFDcEIsS0FBSyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNuQixJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztJQUNqQixDQUFDO0lBRUQsUUFBUTtRQUNOLE9BQU8sdUJBQXVCLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQztJQUN2RCxDQUFDO0NBQ0Y7QUFiRCwwQ0FhQztBQUVELE1BQWEsdUJBQXdCLFNBQVEsZUFBZTtJQUsxRCxZQUFZLEdBQVUsRUFBRSxVQUFrQixFQUFFLE9BQWUsRUFBRSxLQUFvQjtRQUMvRSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFWCxJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztRQUM3QixJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN2QixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUNyQixDQUFDO0lBRUQsUUFBUTtRQUNOLE9BQU8s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LEVBQUUsRUFBRSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0tBQ2xFO0lBQUMsT0FBTyxHQUFHLEVBQUU7UUFDWixJQUFJLGFBQWEsRUFBRTtZQUNqQixJQUFJLE9BQU8sR0FBRyxZQUFZLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBRXhDLElBQUksT0FBTyxFQUFFO2dCQUNYLElBQUksQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDLEdBQUcsT0FBTyxDQUFDO2dCQUVwQyxPQUFPLElBQUksVUFBVSxDQUFJLEtBQUssRUFBRSxNQUFNLEVBQUUsSUFBSSx1QkFBdUIsQ0FBQyxHQUFHLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxhQUFhLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLGFBQWEsQ0FBQyxDQUFDO2FBQ3BKO1NBQ0Y7UUFFRCxPQUFPLElBQUksVUFBVSxDQUFJLEtBQUssRUFBRSxNQUFNLEVBQUUsSUFBSSxlQUFlLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0tBQ3RGO0FBQ0gsQ0FBQztBQW5GRCx3QkFtRkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFcnJvclJlcG9ydGVyLCBOb0Vycm9yUmVwb3J0ZXIsIENvbXB0cm9sbGVyRXJyb3JSZXBvcnRlciB9IGZyb20gJy4vRXJyb3JSZXBvcnRlcic7XG5pbXBvcnQgeyBtdXN0QXJyYXkgfSBmcm9tICcuL1V0aWxzJztcbmltcG9ydCB7IFdvcmxkIH0gZnJvbSAnLi9Xb3JsZCc7XG5pbXBvcnQgeyBlbmNvZGVkTnVtYmVyIH0gZnJvbSAnLi9FbmNvZGluZyc7XG5pbXBvcnQgeyBUcmFuc2FjdGlvblJlY2VpcHQgfSBmcm9tICd3ZWIzLWV0aCc7XG5cbmNvbnN0IGVycm9yUmVnZXggPSAvXiguKikgXFwoKFxcZCspXFwpJC9cblxuZnVuY3Rpb24gZ2V0RXJyb3JDb2RlKHJldmVydE1lc3NhZ2U6IHN0cmluZyk6IFtzdHJpbmcsIG51bWJlcl0gfCBudWxsIHtcbiAgbGV0IHJlcyA9IGVycm9yUmVnZXguZXhlYyhyZXZlcnRNZXNzYWdlKTtcblxuICBpZiAocmVzKSB7XG4gICAgcmV0dXJuIFtyZXNbMV0sIE51bWJlcihyZXNbMl0pXTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEludm9rYXRpb25PcHRzIHtcbiAgZnJvbT86IHN0cmluZyxcbiAgZ2FzPzogbnVtYmVyLFxuICBnYXNQcmljZT86IG51bWJlclxufVxuXG5leHBvcnQgY2xhc3MgSW52b2thdGlvbkVycm9yIGV4dGVuZHMgRXJyb3Ige1xuICBlcnI6IEVycm9yXG4gIC8vIGZ1bmN0aW9uIDogc3RyaW5nXG4gIC8vIGFyZ3VtZW50cyA6IHtbXX1cblxuICBjb25zdHJ1Y3RvcihlcnI6IEVycm9yKSB7XG4gICAgc3VwZXIoZXJyLm1lc3NhZ2UpO1xuICAgIHRoaXMuZXJyID0gZXJyO1xuICB9XG5cbiAgdG9TdHJpbmcoKSB7XG4gICAgcmV0dXJuIGBJbnZva2F0aW9uRXJyb3I8ZXJyPSR7dGhpcy5lcnIudG9TdHJpbmcoKX0+YDtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgSW52b2thdGlvblJldmVydEZhaWx1cmUgZXh0ZW5kcyBJbnZva2F0aW9uRXJyb3Ige1xuICBlcnJDb2RlOiBudW1iZXJcbiAgZXJyb3I6IHN0cmluZyB8IG51bGxcbiAgZXJyTWVzc2FnZTogc3RyaW5nXG5cbiAgY29uc3RydWN0b3IoZXJyOiBFcnJvciwgZXJyTWVzc2FnZTogc3RyaW5nLCBlcnJDb2RlOiBudW1iZXIsIGVycm9yOiBzdHJpbmcgfCBudWxsKSB7XG4gICAgc3VwZXIoZXJyKTtcblxuICAgIHRoaXMuZXJyTWVzc2FnZSA9IGVyck1lc3NhZ2U7XG4gICAgdGhpcy5lcnJDb2RlID0gZXJyQ29kZTtcbiAgICB0aGlzLmVycm9yID0gZXJyb3I7XG4gIH1cblxuICB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gYEludm9rYXRpb25SZXZlcnRFcnJvcjxlcnJNZXNzYWdlPSR7dGhpcy5lcnJNZXNzYWdlfSxlcnJDb2RlPSR7dGhpcy5lcnJDb2RlfSxlcnJvcj0ke3RoaXMuZXJyb3J9PmA7XG4gIH1cbn1cblxuaW50ZXJmYWNlIEFyZ3VtZW50IHtcbiAgbmFtZTogc3RyaW5nXG4gIHR5cGU6IHN0cmluZ1xufVxuXG5pbnRlcmZhY2UgTWV0aG9kIHtcbiAgbmFtZTogc3RyaW5nXG4gIGlucHV0czogQXJndW1lbnRbXVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIENhbGxhYmxlPFQ+IHtcbiAgZXN0aW1hdGVHYXM6IChJbnZva2F0aW9uT3B0cz8pID0+IFByb21pc2U8bnVtYmVyPlxuICBjYWxsOiAoSW52b2thdGlvbk9wdHM/KSA9PiBQcm9taXNlPFQ+XG4gIF9tZXRob2Q6IE1ldGhvZFxuICBhcmd1bWVudHM6IGFueVtdXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2VuZGFibGU8VD4gZXh0ZW5kcyBDYWxsYWJsZTxUPiB7XG4gIHNlbmQ6IChJbnZva2F0aW9uT3B0cykgPT4gUHJvbWlzZTxUcmFuc2FjdGlvblJlY2VpcHQ+XG59XG5cbmV4cG9ydCBjbGFzcyBGYWlsdXJlIHtcbiAgZXJyb3I6IHN0cmluZ1xuICBpbmZvOiBzdHJpbmdcbiAgZGV0YWlsOiBzdHJpbmdcblxuICBjb25zdHJ1Y3RvcihlcnJvcjogc3RyaW5nLCBpbmZvOiBzdHJpbmcsIGRldGFpbDogc3RyaW5nKSB7XG4gICAgdGhpcy5lcnJvciA9IGVycm9yO1xuICAgIHRoaXMuaW5mbyA9IGluZm87XG4gICAgdGhpcy5kZXRhaWwgPSBkZXRhaWw7XG4gIH1cblxuICB0b1N0cmluZygpOiBzdHJpbmcge1xuICAgIHJldHVybiBgRmFpbHVyZTxlcnJvcj0ke3RoaXMuZXJyb3J9LGluZm89JHt0aGlzLmluZm99LGRldGFpbD0ke3RoaXMuZGV0YWlsfT5gO1xuICB9XG5cbiAgZXF1YWxzKG90aGVyOiBGYWlsdXJlKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIChcbiAgICAgIHRoaXMuZXJyb3IgPT09IG90aGVyLmVycm9yICYmXG4gICAgICB0aGlzLmluZm8gPT09IG90aGVyLmluZm8gJiZcbiAgICAgIHRoaXMuZGV0YWlsID09PSBvdGhlci5kZXRhaWxcbiAgICApO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBJbnZva2F0aW9uPFQ+IHtcbiAgdmFsdWU6IFQgfCBudWxsXG4gIHJlY2VpcHQ6IFRyYW5zYWN0aW9uUmVjZWlwdCB8IG51bGxcbiAgZXJyb3I6IEVycm9yIHwgbnVsbFxuICBmYWlsdXJlczogRmFpbHVyZVtdXG4gIG1ldGhvZDogc3RyaW5nIHwgbnVsbFxuICBhcmdzOiB7IGFyZzogc3RyaW5nLCB2YWw6IGFueSB9W11cbiAgZXJyb3JSZXBvcnRlcjogRXJyb3JSZXBvcnRlclxuXG4gIGNvbnN0cnVjdG9yKHZhbHVlOiBUIHwgbnVsbCwgcmVjZWlwdDogVHJhbnNhY3Rpb25SZWNlaXB0IHwgbnVsbCwgZXJyb3I6IEVycm9yIHwgbnVsbCwgZm46IENhbGxhYmxlPFQ+IHwgbnVsbCwgZXJyb3JSZXBvcnRlcjogRXJyb3JSZXBvcnRlcj1Ob0Vycm9yUmVwb3J0ZXIpIHtcbiAgICB0aGlzLnZhbHVlID0gdmFsdWU7XG4gICAgdGhpcy5yZWNlaXB0ID0gcmVjZWlwdDtcbiAgICB0aGlzLmVycm9yID0gZXJyb3I7XG4gICAgdGhpcy5lcnJvclJlcG9ydGVyID0gZXJyb3JSZXBvcnRlcjtcblxuICAgIGlmIChmbiAhPT0gbnVsbCkge1xuICAgICAgdGhpcy5tZXRob2QgPSBmbi5fbWV0aG9kLm5hbWU7XG4gICAgICB0aGlzLmFyZ3MgPSBmbi5hcmd1bWVudHMubWFwKChhcmd1bWVudCwgaSkgPT4gKHsgYXJnOiBmbi5fbWV0aG9kLmlucHV0c1tpXS5uYW1lLCB2YWw6IGFyZ3VtZW50IH0pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5tZXRob2QgPSBudWxsO1xuICAgICAgdGhpcy5hcmdzID0gW107XG4gICAgfVxuXG4gICAgaWYgKHJlY2VpcHQgIT09IG51bGwgJiYgcmVjZWlwdC5ldmVudHMgJiYgcmVjZWlwdC5ldmVudHNbXCJGYWlsdXJlXCJdKSB7XG4gICAgICBjb25zdCBmYWlsdXJlcyA9IG11c3RBcnJheShyZWNlaXB0LmV2ZW50c1tcIkZhaWx1cmVcIl0pO1xuXG4gICAgICB0aGlzLmZhaWx1cmVzID0gZmFpbHVyZXMubWFwKChmYWlsdXJlKSA9PiB7XG4gICAgICAgIGNvbnN0IHsgJ2Vycm9yJzogZXJyb3JWYWwsICdpbmZvJzogaW5mb1ZhbCwgJ2RldGFpbCc6IGRldGFpbFZhbCB9ID0gZmFpbHVyZS5yZXR1cm5WYWx1ZXM7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBGYWlsdXJlKFxuICAgICAgICAgIGVycm9yUmVwb3J0ZXIuZ2V0RXJyb3IoZXJyb3JWYWwpIHx8IGB1bmtub3duIGVycm9yPSR7ZXJyb3JWYWx9YCxcbiAgICAgICAgICBlcnJvclJlcG9ydGVyLmdldEluZm8oaW5mb1ZhbCkgfHwgYHVua25vd24gaW5mbz0ke2luZm9WYWx9YCxcbiAgICAgICAgICBlcnJvclJlcG9ydGVyLmdldERldGFpbChlcnJvclZhbCwgZGV0YWlsVmFsKVxuICAgICAgICApO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZmFpbHVyZXMgPSBbXTtcbiAgICB9XG4gIH1cblxuICBzdWNjZXNzKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLmVycm9yID09PSBudWxsICYmIHRoaXMuZmFpbHVyZXMubGVuZ3RoID09PSAwXG4gICAgKTtcbiAgfVxuXG4gIGludm9rYXRpb24oKTogc3RyaW5nIHtcbiAgICBpZiAodGhpcy5tZXRob2QpIHtcbiAgICAgIGxldCBhcmdTdHIgPSB0aGlzLmFyZ3MubWFwKCh7IGFyZywgdmFsIH0pID0+IGAke2FyZ309JHt2YWwudG9TdHJpbmcoKX1gKS5qb2luKCcsJyk7XG4gICAgICByZXR1cm4gYFwiJHt0aGlzLm1ldGhvZH0oJHthcmdTdHJ9KVwiYDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGB1bmtub3duIG1ldGhvZGA7XG4gICAgfVxuICB9XG5cbiAgdG9TdHJpbmcoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYEludm9rYXRpb248JHt0aGlzLmludm9rYXRpb24oKX0sIHR4PSR7dGhpcy5yZWNlaXB0ID8gdGhpcy5yZWNlaXB0LnRyYW5zYWN0aW9uSGFzaCA6ICcnfSwgdmFsdWU9JHt0aGlzLnZhbHVlID8gKDxhbnk+dGhpcy52YWx1ZSkudG9TdHJpbmcoKSA6ICcnfSwgZXJyb3I9JHt0aGlzLmVycm9yfSwgZmFpbHVyZXM9JHt0aGlzLmZhaWx1cmVzLnRvU3RyaW5nKCl9PmA7XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZhbGxiYWNrKHdvcmxkOiBXb3JsZCwgZnJvbTogc3RyaW5nLCB0bzogc3RyaW5nLCB2YWx1ZTogZW5jb2RlZE51bWJlcik6IFByb21pc2U8SW52b2thdGlvbjxzdHJpbmc+PiB7XG4gIGxldCB0cnhPYmogPSB7XG4gICAgZnJvbTogZnJvbSxcbiAgICB0bzogdG8sXG4gICAgdmFsdWU6IHZhbHVlLnRvU3RyaW5nKClcbiAgfTtcblxuICBsZXQgZXN0aW1hdGVHYXMgPSBhc3luYyAob3B0czogSW52b2thdGlvbk9wdHMpID0+IHtcbiAgICBsZXQgdHJ4T2JqTWVyZ2VkID0ge1xuICAgICAgLi4udHJ4T2JqLFxuICAgICAgLi4ub3B0c1xuICAgIH07XG5cbiAgICByZXR1cm4gPG51bWJlcj5hd2FpdCB3b3JsZC53ZWIzLmV0aC5lc3RpbWF0ZUdhcyh0cnhPYmpNZXJnZWQpO1xuICB9O1xuXG4gIGxldCBjYWxsID0gYXN5bmMgKG9wdHM6IEludm9rYXRpb25PcHRzKSA9PiB7XG4gICAgbGV0IHRyeE9iak1lcmdlZCA9IHtcbiAgICAgIC4uLnRyeE9iaixcbiAgICAgIC4uLm9wdHNcbiAgICB9O1xuXG4gICAgcmV0dXJuIDxzdHJpbmc+YXdhaXQgd29ybGQud2ViMy5ldGguY2FsbCh0cnhPYmpNZXJnZWQpO1xuICB9O1xuXG4gIGxldCBzZW5kID0gYXN5bmMgKG9wdHM6IEludm9rYXRpb25PcHRzKSA9PiB7XG4gICAgbGV0IHRyeE9iak1lcmdlZCA9IHtcbiAgICAgIC4uLnRyeE9iaixcbiAgICAgIC4uLm9wdHNcbiAgICB9O1xuXG4gICAgbGV0IHJlY2VpcHQgPSBhd2FpdCB3b3JsZC53ZWIzLmV0aC5zZW5kVHJhbnNhY3Rpb24odHJ4T2JqTWVyZ2VkKTtcbiAgICByZWNlaXB0LmV2ZW50cyA9IHt9O1xuXG4gICAgcmV0dXJuIHJlY2VpcHQ7XG4gIH1cblxuICBsZXQgZm46IFNlbmRhYmxlPHN0cmluZz4gPSB7XG4gICAgZXN0aW1hdGVHYXM6IGVzdGltYXRlR2FzLFxuICAgIGNhbGw6IGNhbGwsXG4gICAgc2VuZDogc2VuZCxcbiAgICBfbWV0aG9kOiB7XG4gICAgICBuYW1lOiBcImZhbGxiYWNrXCIsXG4gICAgICBpbnB1dHM6IFtdXG4gICAgfSxcbiAgICBhcmd1bWVudHM6IFtdXG4gIH1cblxuICByZXR1cm4gaW52b2tlPHN0cmluZz4od29ybGQsIGZuLCBmcm9tLCBOb0Vycm9yUmVwb3J0ZXIpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaW52b2tlPFQ+KHdvcmxkOiBXb3JsZCwgZm46IFNlbmRhYmxlPFQ+LCBmcm9tOiBzdHJpbmcsIGVycm9yUmVwb3J0ZXI6IEVycm9yUmVwb3J0ZXIgPSBOb0Vycm9yUmVwb3J0ZXIpOiBQcm9taXNlPEludm9rYXRpb248VD4+IHtcbiAgbGV0IHZhbHVlOiBUIHwgbnVsbCA9IG51bGw7XG4gIGxldCByZXN1bHQ6IFRyYW5zYWN0aW9uUmVjZWlwdCB8IG51bGwgPSBudWxsO1xuICBsZXQgd29ybGRJbnZva2F0aW9uT3B0cyA9IHdvcmxkLmdldEludm9rYXRpb25PcHRzKHtmcm9tOiBmcm9tfSk7XG4gIGxldCB0cnhJbnZva2F0aW9uT3B0cyA9IHdvcmxkLnRyeEludm9rYXRpb25PcHRzLnRvSlMoKTtcblxuICBsZXQgaW52b2thdGlvbk9wdHMgPSB7XG4gICAgLi4ud29ybGRJbnZva2F0aW9uT3B0cyxcbiAgICAuLi50cnhJbnZva2F0aW9uT3B0c1xuICB9O1xuXG4gIGlmICh3b3JsZC50b3RhbEdhcykge1xuICAgIGludm9rYXRpb25PcHRzID0ge1xuICAgICAgLi4uaW52b2thdGlvbk9wdHMsXG4gICAgICBnYXM6IHdvcmxkLnRvdGFsR2FzXG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBnYXMgPSBhd2FpdCBmbi5lc3RpbWF0ZUdhcyh7IC4uLmludm9rYXRpb25PcHRzIH0pO1xuICAgICAgaW52b2thdGlvbk9wdHMgPSB7XG4gICAgICAgIC4uLmludm9rYXRpb25PcHRzLFxuICAgICAgICBnYXM6IGdhcyAqIDJcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaW52b2thdGlvbk9wdHMgPSB7XG4gICAgICAgIC4uLmludm9rYXRpb25PcHRzLFxuICAgICAgICBnYXM6IDIwMDAwMDBcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgdHJ5IHtcbiAgICBsZXQgZXJyb3I6IG51bGwgfCBFcnJvciA9IG51bGw7XG5cbiAgICB0cnkge1xuICAgICAgdmFsdWUgPSBhd2FpdCBmbi5jYWxsKHsgLi4uaW52b2thdGlvbk9wdHMgfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBlcnJvciA9IG5ldyBJbnZva2F0aW9uRXJyb3IoZXJyKTtcbiAgICB9XG5cbiAgICBpZiAod29ybGQuZHJ5UnVuKSB7XG4gICAgICB3b3JsZC5wcmludGVyLnByaW50TGluZShgRHJ5IHJ1bjogaW52b2tpbmcgXFxgJHtmbi5fbWV0aG9kLm5hbWV9XFxgYCk7XG4gICAgICAvLyBYWFhTXG4gICAgICByZXN1bHQgPSA8VHJhbnNhY3Rpb25SZWNlaXB0Pjx1bmtub3duPntcbiAgICAgICAgYmxvY2tOdW1iZXI6IC0xLFxuICAgICAgICB0cmFuc2FjdGlvbkhhc2g6ICcweCcsXG4gICAgICAgIGdhc1VzZWQ6IDAsXG4gICAgICAgIGV2ZW50czoge31cbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc3VsdCA9IGF3YWl0IGZuLnNlbmQoeyAuLi5pbnZva2F0aW9uT3B0cyB9KTtcbiAgICAgIHdvcmxkLmdhc0NvdW50ZXIudmFsdWUgKz0gcmVzdWx0Lmdhc1VzZWQ7XG4gICAgfVxuXG4gICAgaWYgKHdvcmxkLnNldHRpbmdzLnByaW50VHhMb2dzKSB7XG4gICAgICBjb25zdCBldmVudExvZ3MgPSBPYmplY3QudmFsdWVzKHJlc3VsdCAmJiByZXN1bHQuZXZlbnRzIHx8IHt9KS5tYXAoKGV2ZW50OiBhbnkpID0+IHtcbiAgICAgICAgY29uc3QgZXZlbnRMb2cgPSBldmVudC5yYXc7XG4gICAgICAgIGlmIChldmVudExvZykge1xuICAgICAgICAgIGNvbnN0IGV2ZW50RGVjb2RlciA9IHdvcmxkLmV2ZW50RGVjb2RlcltldmVudExvZy50b3BpY3NbMF1dO1xuICAgICAgICAgIGlmIChldmVudERlY29kZXIpIHtcbiAgICAgICAgICAgIHJldHVybiBldmVudERlY29kZXIoZXZlbnRMb2cpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gZXZlbnRMb2c7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGNvbnNvbGUubG9nKCdFTUlUVEVEIEVWRU5UUzogICAnLCBldmVudExvZ3MpO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgSW52b2thdGlvbjxUPih2YWx1ZSwgcmVzdWx0LCBudWxsLCBmbiwgZXJyb3JSZXBvcnRlcik7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChlcnJvclJlcG9ydGVyKSB7XG4gICAgICBsZXQgZGVjb2RlZCA9IGdldEVycm9yQ29kZShlcnIubWVzc2FnZSk7XG5cbiAgICAgIGlmIChkZWNvZGVkKSB7XG4gICAgICAgIGxldCBbZXJyTWVzc2FnZSwgZXJyQ29kZV0gPSBkZWNvZGVkO1xuXG4gICAgICAgIHJldHVybiBuZXcgSW52b2thdGlvbjxUPih2YWx1ZSwgcmVzdWx0LCBuZXcgSW52b2thdGlvblJldmVydEZhaWx1cmUoZXJyLCBlcnJNZXNzYWdlLCBlcnJDb2RlLCBlcnJvclJlcG9ydGVyLmdldEVycm9yKGVyckNvZGUpKSwgZm4sIGVycm9yUmVwb3J0ZXIpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBuZXcgSW52b2thdGlvbjxUPih2YWx1ZSwgcmVzdWx0LCBuZXcgSW52b2thdGlvbkVycm9yKGVyciksIGZuLCBlcnJvclJlcG9ydGVyKTtcbiAgfVxufVxuIl19